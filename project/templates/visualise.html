<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        .border {
            border: 3px solid green;
        }

        .options {
            font-size: 12px;
        }

        .alt1 {
            background-color: aquamarine;
        }

        .alt2 {
            background-color: aqua;
        }
    </style>
</head>
<body>
    <script src="../static/js/jquery-3.3.1.min.js"></script>
    Welcome to PDPC_Coin <b>Visualiser:</b><br />
    <button type="button" class="options" id="test">test</button>
    <table width="100%" border="1">
        <tr>
            <td>
                <table id="sets">
                    <tr>
                        <td class="options">
                            Scan: <input type="checkbox" id="scan">
                            <button type="button" class="options" onClick="JavaScript:scan(0)">start</button>
                            <button type="button" class="options" onClick="JavaScript:scan(-1)">stop</button>
                            <button type="button" class="options" onClick="JavaScript:step()">step</button>
                        </td>
                    </tr>
                    <tr>
                        <td id="opt" class="options alt1">
                            IPMinMax 127.0.0.x:
                            <input type="text" value="1" class="options" size="5" id="IPMin">
                            <input type="text" value="10" class="options" size="5" id="IPMax">
                            <br />
                            Circle
                            <select id="circle" class="options">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                            Max. nodes
                            <select id="maxnodes" class="options">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                            <select id="type" class="options">
                                <option value="BCNode">BCNode</option>
                                <option value="Wallet">Wallet</option>
                                <option value="Miner">Miner</option>
                            </select>
                            <br />
                            Offset:
                            <input type="range" min="1" max="360" value="50" class="options" id="off1" oninput="drawCanvas();">
                            <br />
                            Size:
                            <input type="range" min="1" max="100" value="50" class="options" id="siz1" oninput="drawCanvas();">
                        </td>
                    </tr>
                    <tr>
                        <td id="opt" class="options alt1">
                            IPMinMax 127.0.0.x:
                            <input type="text" value="1" class="options" size="5" id="IPMin">
                            <input type="text" value="1" class="options" size="5" id="IPMax">
                            <br />
                            Circle
                            <select id="circle" class="options">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                            Max. nodes
                            <select id="maxnodes" class="options">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                            <select id="type" class="options">
                                <option value="BCNode">BCNode</option>
                                <option value="Wallet">Wallet</option>
                                <option value="Miner">Miner</option>
                            </select>
                            <br />
                            Offset:
                            <input type="range" min="1" max="360" value="50" class="options" id="off2" oninput="drawCanvas();">
                            <br />
                            Size:
                            <input type="range" min="1" max="100" value="50" class="options" id="siz2" oninput="drawCanvas();">
                        </td>
                    </tr>
                    <tr>
                        <td id="opt" class="options alt1">
                            IPMinMax 127.0.0.x:
                            <input type="text" value="1" class="options" size="5" id="IPMin">
                            <input type="text" value="1" class="options" size="5" id="IPMax">
                            <br />
                            Circle
                            <select id="circle" class="options">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                            Max. nodes
                            <select id="maxnodes" class="options">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                            <select id="type" class="options">
                                <option value="BCNode">BCNode</option>
                                <option value="Wallet">Wallet</option>
                                <option value="Miner">Miner</option>
                            </select>
                            <br />
                            Offset:
                            <input type="range" min="1" max="360" value="50" class="options" id="off3" oninput="drawCanvas();">
                            <br />
                            Size:
                            <input type="range" min="1" max="100" value="50" class="options" id="siz3" oninput="drawCanvas();">
                        </td>
                    </tr>
                    <tr>
                        <td id="opt" class="options alt2">
                            IPMinMax 127.0.0.x:
                            <input type="text" value="1" class="options" size="5" id="IPMin">
                            <input type="text" value="1" class="options" size="5" id="IPMax">
                            <br />
                            Circle
                            <select id="circle" class="options">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                            Max. nodes
                            <select id="maxnodes" class="options">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                            <select id="type" class="options">
                                <option value="BCNode">BCNode</option>
                                <option value="Wallet">Wallet</option>
                                <option value="Miner">Miner</option>
                            </select>
                            <br />
                            Offset:
                            <input type="range" min="1" max="360" value="50" class="options" id="off4" oninput="drawCanvas();">
                            <br />
                            Size:
                            <input type="range" min="1" max="100" value="50" class="options" id="siz4" oninput="drawCanvas();">
                        </td>
                    </tr>
                    <tr>
                        <td id="opt" class="options alt1">
                            IPMinMax 127.0.0.x:
                            <input type="text" value="1" class="options" size="5" id="IPMin">
                            <input type="text" value="1" class="options" size="5" id="IPMax">
                            <br />
                            Circle
                            <select id="circle" class="options">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                            Max. nodes
                            <select id="maxnodes" class="options">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                            <select id="type" class="options">
                                <option value="BCNode">BCNode</option>
                                <option value="Wallet">Wallet</option>
                                <option value="Miner">Miner</option>
                            </select>
                            <br />
                            Offset:
                            <input type="range" min="1" max="360" value="50" class="options" id="off5" oninput="drawCanvas();">
                            <br />
                            Size:
                            <input type="range" min="1" max="100" value="50" class="options" id="siz5" oninput="drawCanvas();">
                        </td>
                    </tr>
                </table>
            </td>
            <td align="center">
                Time Delay <input type="range" min="1" max="5000" value="200" class="slider" id="delay">
                Canvas Width <input type="range" min="100" max="900" value="500" class="slider" id="twidth" oninput="setCanvas();">
                <br />
                <canvas id="canvas" class="border" >Oops, no canvas supported by your browser?</canvas>
            </td>
        </tr>
    </table>
    REST-API log:
    <button type="button" onClick="document.getElementById('response').value=''">Reset Log</button>
    <div>
        <textarea id="response" cols="120" rows="15">
                    </textarea>
    </div>

    <script>
        nodes = {
            "B": {},
            "W": {},
            "M": {}
        }

        rings = [[],[],[],[],[]]

        ctx = null

        $(document).ready(function () {
            ctx = $("#canvas")[0].getContext('2d');
            $("#scan").prop("checked", false);
            setCanvas();
        });

        function getWidth() {
            return $("#twidth")[0].value
        }

        function setCanvas() {
            ctx.canvas.width = getWidth();
            ctx.canvas.height = getWidth();
            drawCanvas();
        }

        $("#test").on("click", function () {

        });
        $("#scan").on("change", function () {
            if (this.checked) {
                rings = [[], [], [], [], []]
                setTimeout(doScan(),100);
            }
        });
 
        stopit = false;
        // TODO make the scanning button inactive, else scan runs multiple times
        function doScan() {
            var ring = 0
            $("td[id*='opt']").each(function () {
                var min = parseInt($(this).find("#IPMin")[0].value);
                var max = parseInt($(this).find("#IPMax")[0].value);
                var typ = $(this).find("#type")[0];
                // TODO alert ignore double
                if ((min * max > 0) && (min >0) && (min<128) && (max<128)) {
                    for (var ipx = min; ipx <= max; ipx++) {
                        scanFor(ipx, typ.value, ring);
                    }
                }
                ring++;
            });
        }

        function scanFor(ipIn, typIn, ringIn) {
            var ip = ipIn;
            var typ = typIn.substring(0, 1);
            var ring = ringIn;
            if (ip < 0) {
                stopit = true;
            } else {
                stopit = false;
            }
            if (stopit) {
                return;
            }
            port = 5555
            var dom = "http://127.0.0." + ip + ":" + port
            var url = dom + "/cfg";
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    addLog("\n(" + typ + ") Reply:" + url, false);
                    var avail = nodes[typ]
                    if (this.status == 200) {
                        text = this.responseText;
                        jstext = JSON.parse(text);
                        if (jstext['type'].startsWith(typ)) {
                            var found = false
                            for (var i = 0; i < rings[ring].length; i++) {
                                if (rings[ring][i] == dom) {
                                    found = true;
                                    break;
                                }
                            }
                            if (found == false) {
                                rings[ring].push(dom);
                            }
                            if (avail.hasOwnProperty(dom)) {
                                nodes[typ][dom]['ping'] = true;
                            } else {
                                nodes[typ][dom] = { "ping": true, "ring": ring };
                            }

                            if (!text.startsWith("[]")) {
                                addLog("\n" + text, false);
                            } else {
                                addLog(" ===> []", false);
                            }
                        } else {
                            addLog("Wrong node detected in range: " + jstext['type'] + "for ring " + ring + " expected " + typ);
                        }
                    } else {
                        text = " ==> Error: " + this.status + " with '" + this.responseText + "'";
                        addLog(text, false);
                        if (avail.hasOwnProperty(dom)) {
                            nodes[typ][dom]['ping'] = false;
                        } else {

                        }
                    }
                    if (!stopit) {
                        //setTimeout(scan(ip + 1), 200);
                    }
                    drawCanvas();
                }
            };
            xhttp.open("GET", url, true);
            xhttp.send();
        }

        function scan(ipIn,typIn,ringIn) {
            var ip = ipIn;
            var typ = typIn.substring(0, 1);
            var ring = ringIn;
            if (ip < 0) {
                stopit = true;
            } else {
                stopit = false;
            }
            if (stopit) {
                return;
            }
            port = 5555
            var dom = "http://127.0.0." + ip + ":" + port
            var url = dom + "/visual";
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4) {
                    addLog("\n(" + typ + ") Reply:" + url, false);
                    var avail = nodes[typ]
                    var found = false
                    for (var i = 0; i < rings[ring].length; i++) {
                        if (rings[ring][i] == dom) {
                            found = true;
                            break;
                        }
                    }
                    if (found == false) {
                        rings[ring].push(dom);
                    }
                    if (this.status == 200) {
                        if (avail.hasOwnProperty(dom)) {
                            nodes[typ][dom]['ping'] = true;
                        } else {
                            nodes[typ][dom] = { "ping": true, "ring":ring };
                        }
                        text = this.responseText;
                        if (!text.startsWith("[]")) {
                            addLog("\n" + text, false);
                        } else {
                            addLog(" ===> []", false);
                        }
                    } else {
                        text = " ==> Error: " + this.status + " with '" + this.responseText + "'";
                        addLog(text, false);
                        if (avail.hasOwnProperty(dom)) {
                            nodes[typ][dom]['ping'] = false;
                        } else {
                            
                        }
                    }
                    if (!stopit) {
                        //setTimeout(scan(ip + 1), 200);
                    }
                    drawCanvas();
                }
            };
            xhttp.open("GET", url, true);
            xhttp.send();
        }

        // helper function to show results as
        function addLog(text, start) {
            if (start == true) {
                ntext = "\n---- [Command count:" + cnt + "]" + text
                cnt++
            } else {
                //ntext = "\n\r==> Reply:\n\r"+text
                ntext = text
            }
            document.getElementById("response").value = document.getElementById("response").value + ntext;
            return ntext
        }

        function drawNode(typ,dom,x,y,size,col1,col2,col3) {
            var n = nodes[typ];
            if (n.hasOwnProperty(dom)) {
                var item = n[dom]
                if (item['ping'] === true) {
                    var gr = ctx.createRadialGradient(x, y, size/4, x, y, size);
                    gr.addColorStop(0, col1);
                    gr.addColorStop(0.5, col2);
                    gr.addColorStop(1, col3);
                    ctx.fillStyle = gr;
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2, false);
                    ctx.closePath();
                    ctx.fill();
                } else {
                    ctx.fillStyle = "orange";
                    ctx.fillRect(x, y, size,size);
                }
                ctx.fillStyle = "black";
                ctx.font = "10px _sans";
                ctx.textBaseline = "top";
                var ipa = typ
                var pos = dom.lastIndexOf(":")
                if (pos > 0) {
                    ipa = dom.substring(0, pos);
                    pos = ipa.lastIndexOf(".");
                    if (pos > 0) {
                        ipa = typ+"/"+ipa.substring(pos+1);
                    }
                }
                ctx.fillText(ipa, x-size/2, y);
                return true;
            }
            return false;
        }

         function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            var setSizes = [];
            var rot = [];
            for (var i = 1; i < rings.length+1; i++) {
                setSizes.push(parseInt($("#siz" + i)[0].value));
                rot.push(parseInt($("#off" + i)[0].value));
            }

            var srad = Math.trunc((getWidth() *.45) / (rings.length * 1));
            var center_x = getWidth() / 2;
            var center_y = center_x;
            
            for(var ring = 0; ring < rings.length; ring++) {
                r = rings[ring];
                var radius = srad * (ring + 1);
                ctx.beginPath();
                ctx.arc(center_x,center_y, radius, 0, 2 * Math.PI,false);
                ctx.stroke();
                var size = (srad*2/3) * (setSizes[ring] / 100);
                for(var rr = 0; rr < r.length; rr++) {
                    //var x = (rr+1) * 100;
                    //var y = (ring + 1) * 100;
                    var angle = (360 / r.length) * rr + rot[ring];
                    var x = center_x + radius * Math.cos(-angle * Math.PI / 180);
                    var y = center_y + radius * Math.sin(-angle * Math.PI / 180);
                    if (!drawNode("B", r[rr], x, y, size, 'rgb(0,255,0)', 'rgb(0,0,255)', 'rgb(255,0,0)')) {
                        if (!drawNode("W", r[rr], x, y, size, 'rgb(255,255,0)', 'rgb(0,255,255)', 'rgb(255,0,255)')) {
                            if (!drawNode("M", r[rr], x, y, size, 'rgb(255,255,255)', 'rgb(0,255,0)', 'rgb(0,255,255)')) {
                                ctx.fillStyle = "red";
                                ctx.beginPath();
                                ctx.arc(x, y, size, 0, Math.PI * 2, true);
                                ctx.closePath();
                                ctx.fill();
                            }
                        }
                    }
                }
            }
        }

    </script>
</body>
</html>